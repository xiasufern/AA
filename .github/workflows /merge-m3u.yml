name: è‡ªåŠ¨åˆå¹¶M3Uï¼ˆä½¿ç”¨Cloudflareä»£ç†ï¼‰

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å®šæ—¶è§¦å‘ï¼šåŒ—äº¬æ—¶é—´ 06:00 å’Œ 18:00
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00 = åŒ—äº¬æ—¶é—´ 06:00
    - cron: '0 10 * * *'  # UTC 10:00 = åŒ—äº¬æ—¶é—´ 18:00
  
  # å½“è„šæœ¬æ›´æ–°æ—¶ä¹Ÿè§¦å‘
  push:
    paths:
      - 'scripts/merge_from_proxy.py'
      - '.github/workflows/merge-m3u.yml'

jobs:
  merge-m3u:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        pip install requests beautifulsoup4
    
    - name: ğŸš€ è¿è¡Œåˆå¹¶è„šæœ¬
      run: |
        echo "å¼€å§‹è¿è¡Œåˆå¹¶è„šæœ¬..."
        python scripts/merge_from_proxy.py
        
        echo -e "\n=== æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶ ==="
        if [ -f "CC.m3u" ]; then
          echo "âœ… CC.m3u å·²ç”Ÿæˆ"
          echo "æ–‡ä»¶å¤§å°: $(wc -c < CC.m3u) å­—èŠ‚"
          echo "è¡Œæ•°: $(wc -l < CC.m3u)"
          echo -e "\nå‰5è¡Œå†…å®¹:"
          head -5 CC.m3u
          echo "..."
        else
          echo "âŒ CC.m3u æœªç”Ÿæˆ"
          exit 1
        fi
    
    - name: ğŸ“¤ æäº¤æ–‡ä»¶
      run: |
        # é…ç½®Git
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # æ£€æŸ¥CC.m3uæ˜¯å¦å­˜åœ¨
        if [ -f "CC.m3u" ]; then
          echo "å‡†å¤‡æäº¤CC.m3u..."
          
          # æ·»åŠ æ–‡ä»¶
          git add CC.m3u
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --cached --quiet; then
            echo "ğŸ“­ æ–‡ä»¶æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            # æäº¤å¹¶æ¨é€
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° CC.m3u [$(date +'%Y-%m-%d %H:%M')]"
            git push
            echo "âœ… æäº¤å®Œæˆ"
          fi
        else
          echo "âŒ CC.m3uä¸å­˜åœ¨ï¼Œæ— æ³•æäº¤"
          exit 1
        fi
    
    - name: ğŸ“Š è¾“å‡ºç»“æœ
      run: |
        echo "=== è¿è¡Œå®Œæˆ ==="
        echo "ğŸ“… æ—¶é—´: $(date)"
        echo "ğŸ”— ä»£ç†åœ°å€: https://smt-proxy.sufern001.workers.dev/"
        echo "ğŸ“ ç”Ÿæˆæ–‡ä»¶: CC.m3u"
        echo "ğŸŒ è®¿é—®é“¾æ¥:"
        echo "  - GitHub: https://github.com/${{ github.repository }}/blob/main/CC.m3u"
        echo "  - Raw: https://raw.githubusercontent.com/${{ github.repository }}/main/CC.m3u"
